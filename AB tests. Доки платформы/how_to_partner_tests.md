## Как подготовить дизайн теста по партнерам 

### Перед началом дизайна эксперимента

- Необходимо убедиться, что вы используете корректный дизайн А/Б теста и вам нужен дизайн именно тест по партнерам. Если сомневаетесь, приходите с документацией теста в ~ab-stores.
- Определены метрики и минимальные ожидаемые эффекты для них
- У теста есть [документация](https://wiki.sbmt.io/pages/viewpage.action?pageId=3025185771) в [пространстве](https://wiki.sbmt.io/pages/viewpage.action?pageId=3022176076) платформы экспериментов

### Как использовать библиотеку

1. Клонировать этот репозиторий
`git clone https://gitlab.sbmt.io/analytics/datazone/ab_methodology.git`
2. Установить [poetry](https://python-poetry.org/docs/). Дополнительно про установку и использование poetry можно почитать [здесь](https://wiki.sbmt.io/display/ANLT/Poetry).
3. Проверить установку poetry: ``poetry --version`` 
4. Выполнить ``poetry install --no-root``
5. Если вы используете библиотеку из ноутбука: 
    - ``poetry add ipykernel``
    - ``poetry run python -m ipykernel install --user --name ab_methodology``
    - выбрать установленный кернел 
6. Заполнить .env файл с кредами к БД. Публичный файл лежит ``data/connectors.env``
7. Если запускаете библиотеку из ноутбука: ``%dotenv /full/path/to/connectors.env`` или ``load_dotenv("/full/path/to/connectors.env")``


#### Использование через ноутбук

Сейчас поддерживается дизайн партнерских тестов только через ноутбук. Пример ноутбука лежит в [partners_test_example.ipynb](notebooks/partners_test_example.ipynb). 

## Определение генеральной совокупности партнеров 
В [get_partners.py](data/get_partners.py) находятся функции для определения генеральной совокупности партнера. Набор партнеров, которые будут участвовать в эксперименте, фиксируется заранее, новые партнеры не добавляются в группы после запуска. Рекомендуем использовать в качестве генеральной совокупности тех партнеров, которые завершили хотя бы одну смену за последние 30 дней. 

## Проверяем метрики 

Некоторые метрики партнеров уже определены в соответствующем файле [partner_handel_metrics.py](data/partner_handle_metrics.py), их запросы можно посмотреть [partner_metrics_functions.py](data/partner_metrics_functions.py). Перед использованием стоит обязательно проверить запросы метрик эксперимента, чтобы убедиться, что описанная в запросах логика вам подходит.

#### Добавление метрик 
Для добавления метрик есть определенные требования, часть из них обусловлена функциональностью, часть удобством использования. Пожалуйста, придерживайтесь их.

1. Запросы для метрик хранятся в [partner_metrics_functions.py](data/partner_metrics_functions.py)
2. Для каждой метрики запросы для числителя и знаменателя определяются отдельно. Для обозначения числителя мы добавляем к названию метрики `_num`, для знаменателя -- `_denom`.
3. Требования к функциям:
    1. Называется по имени метрики с префиксом get (например, get_ar_num)
    2. В докстринге указаны пояснения к метрике / есть название тикета теста, в рамках которого метрика создается
    3. Принимает аргументы для фильтрации по времени `date_from` и `date_to`
4. В каждом запросе должны присутствовать следующие поля:
    1. Название метрики 
    2. Дата в формате Date с названием Date 
    3. Один из идентификаторов партнера -- `performer_uuid`, `shopper_login` (login из shoppers), `phone` (из shoppers), `shopper_id` (id из shoppers). 

Давайте добавим метрику AR, которая считается как $\frac{Кол-во\ принятых\ заказов}{Все\ заказы}$.Запросы должны возвращать сырые данные, без лишних агрегаций. Так числитель -- бинарная метрика, то есть для каждого заказа определяется принял ли его партнер или нет. Метрики будут суммироваться к партнеру во время дизайна, поэтому для того, чтобы посчитать все заказы для знаменателя, проставляем единицы. Добавляем новые метрики в [partner_metrics_functions.py](data/partner_metrics_functions.py). 

```python 
def get_ar_num(start_date, end_date):
    q = f"""
    select
        toDate(workflow_created_at) as Date, 
        shipment_uuid,
        performer_uuid, -- уникальный идентификатор исполнителя
        case when assignment_status_str = 'accepted' then 1 else 0 end as ar_num
    from supply.workflow_workflows
    where assignment_status_str in ('accepted', 'timeout')
    and toDate(workflow_created_at) >= toDate('{start_date}')
    and toDate(workflow_created_at) <= toDate('{end_date}')
    """
    return read_sql_query(q, con="click")

def get_ar_denum(start_date, end_date):
    q = f"""
    select
        toDate(workflow_created_at) as Date, 
        city,
        operational_zone_id, 
        shipment_uuid,
        performer_uuid, -- уникальный идентификатор исполнителя
        1 as ar_denum
    from supply.workflow_workflows
    where assignment_status_str in ('accepted', 'timeout')
    and toDate(workflow_created_at) >= toDate('{start_date}')
    and toDate(workflow_created_at) <= toDate('{end_date}')
    """
    return read_sql_query(q, con="click")
```

После этого обновляем [partner_handle_metrics.py](data/partner_handle_metrics.py). В словарь [partner_metrics_definition](data/partner_handle_metrics.py#L4) добавим название метрики и числитель и знаменатель в формате `{metric: [metric_num, metric_denum]}`, то есть для нашей метрики добавим `{'AR': ['ar_num'], 'ar_denum'}`. Обратите внимание, что числитель и знаменатель здесь должны называться также как и в запросе. Если метрика average и у нее нет числителя, то на этом месте прописываем `None`.  

Вносим названия числителя и знаменателя и соответствующие им функции в словарь [partner_metrics_func](data/partner_handle_metrics.py#L15)): `{'ar_num': get_ar_num, 'ar_denum': get_ar_denum}`.

Не забудьте сделать MR после добавления новых метрик. После того как вы добавите новые метрики, не забудьте сделать MR. После того как вы добавите новые метрики, не забудьте сделать MR. Чтобы убедиться, что запросы и функции для метрик корректные, стоит воспользоваться [ноутбуком](notebooks/check_metrics.ipynb) или напрямую функцией [check_metrics](test_collection/check_metrics.py). Для тестов по партнерам нужно задать ``partner_test=True``. 


### Заполнение конфига

Конфиг представлен в виде словаря, на его заполненную версию можно посмотреть [здесь](test_params/test_params_partners.py).

`test_name` — номер задачи

Мы рекомендуем оставлять именно номер задачи, а не название, тк по нему проще всего определить, какая фича тестируется и кто этот тест проводит. В задачке также стоит указать ссылку на документацию с описанием и результатами.

`w_length` -- длина теста в неделях

Длина эксперимента должна быть кратна 7, это связано с сезонностью и возможно разными эффектами в будни и в выходные, поэтому минимальная рекомендуемая длина теста — 2 недели. С увеличением длины теста до 4х недель мощность увеличивается не сильно, при возможности стоит увеличивать именно кол-во магазинов.

`filter_column_id` -- название колонки для фильтрации всех метрик по юнитам генеральной совокупности

Один из идентификаторов партнера -- `performer_uuid`, `shopper_login` (login из shoppers), `phone` (из shoppers), `shopper_id` (id из shoppers). 

`effects` -- словарь метрика-эффект,

Указывается полное название метрики, оно должно соответствовать названию метрики из [partner_metrics_definition](data/partner_handle_metrics.py#L10). Информационные метрики также стоит вносить в дизайн эксперимента с 3% минимальным ожидаемым эффектом. 

`stratification_params` -- параметры стратификации

- `group_shares` -- список с долями каждой группы, при запуске из файла поддерживаются только 2 группы
- `traffic_size` -- доля трафика (юнитов генеральной совокупности), которую можно сплитовать

    Иногда мы хотим взять только часть генеральной совокупности в тест, например, если раскатка фичи очень дорогая. Однако стоит помнить, что при сокращении генеральной совокупности, мощность будет сокращаться.

- `n_splits` -- количество сплитов для симуляций

    Использование большего кол-ва сплитов помогает повысить точность оценки FPR и мощности, к тому же после фильтрации должно оставаться достаточное кол-во сплитов. Минимальное рекомендуемое кол-во здесь 1000.

- `id_column` -- название колонки-юнита рандомизации

    Один из идентификаторов партнера -- `performer_uuid`, `shopper_login` (login из shoppers), `phone` (из shoppers), `shopper_id` (id из shoppers). 

- `num_metrics` -- список с количественными метриками

   Могут использоваться метрики из тех, которые добавлены в эксперимент и метрики из метрик для стратификации из [partner_stratification_metrics_func](data/partner_handle_metrics.py#L20). 

- `cat_metrics` -- список с категориальными метриками

    Могут использоваться метрики для стратификации из [partner_stratification_metrics_func](data/partner_handle_metrics.py#L20). 

- `n_bins` — кол-во бинов для разбиения количественных метрик

    Чем больше это значение, тем больше будет страт. Мы не хотим, чтобы страт было слишком много, тогда это будет не лучше случайного разбиения. В логах эксперимента можно найти кол-во получившихся страт.

### Загрузка конфига 

После разработки дизайна конфиг нужно загрузить в соответствующую таблицу sandbox.partners_test_params при помощи [upload_test_params](test_collection/utils_upload_splits.py#L111). 

## Стратификация 

В тестах по партнерам стратификация проводится не только по метрикам эксперимента, но и другим метрикам, которые описывают партнеров. Сейчас в качестве таких метрик используются тип транспорта, количество дней с первой смены и количество заказов партнера. Их список есть в словаре [partner_stratification_metrics_func](data/partner_handle_metrics.py#L21), запросы для этих метрик находятся в [partner_stratification_metrics.py](data/partner_stratification_metrics.py). Требования к метрикам и процесс их добавления аналогичен метрикам эксперимента.

### Подведение результатов

Для получения оценки эксперимента заполняются следующие поля:

- `fact_start_date`- дата начала эксперимента в формате YYYY-MM-DD
- `fact_end_date` -- дата окончания эксперимента в формате YYYY-MM-DD

Сплит эксперимента должен называться по формату “split_test_name.csv”, где test_name — поле конфига. Проверьте, что файл так называется.  Для оценки нужно запустить функцию [evaluate_partner_test_cuped](test_collection/get_results.py).

### Что-то случилось

Если что-то не получается или осталось непонятным, у вас есть запрос на добавление функционала или вы заметили ошибку, пишите в ~ab-stores.
