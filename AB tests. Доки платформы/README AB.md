# Test Constructor 

### Основная информация
В этом репозитории находится автоматизация тестов по магазинам и свитчбэк-тестов, с ее использованием можно получить полный дизайн (FPR и power для А/А и А/Б тестов), сплиты и оценку эксперимента. Дизайн и проведение таких тестов проходит отдельно А/Б платформы, т.к. для подготовки эксперимента по магазинам существует отдельная [методология](https://wiki.sbmt.io/pages/viewpage.action?pageId=3017758503). Для выбора параметров эксперимента проводятся А/А тесты на исторических данных и А/Б тесты с добавлением синтетического эффекта.

<details markdown='1'><summary>Методология</summary> 

**A/A тесты**

1. Собираем исторические данные за длительность эксперимента
2. Генерируем много сплитов по правилу, которое будем использовать в эксперименте
3. Для каждого сплита оцениваем эффект и p-value с помощью нашей модели
4. Считаем False Positive Rate — долю тестов, в которых мы зафиксировали стат. значимые изменения, когда мы знаем, что эффекта не было
    1. Считаем A/A тест успешным при FPR < alpha (уровень значимости)
5. Оцениваем смещение оценки – bias, считаем разность среднего оцененного эффекта и нулем
    1. Контролируем отсутствие смещения

**A/Б тесты**

1. Фиксируем ожидаемый эффект, lift
2. Считаем среднее значение метрики – μ и среднеквадратическое отклонение – σ
3. Сэмплируем эффект из N(lift*μ, σ/10)
4. Добавляем эффект к наблюдениям тестовой группы
5. Для каждого сплита оцениваем эффект и p-value с помощью нашей модели
6. Считаем power (мощность) — долю тестов, в которых мы зафиксировали стат. значимые изменения, когда мы знаем, что эффект был 
    1. Считаем A/Б тест успешным при power > 0.7
7. Оцениваем смещение оценки – bias, считаем разность среднего оцененного эффекта и среднего синтетического эффекта
    1. Контролируем отсутствие смещения
</details>


## Использование библиотеки 
1. Клонировать этот репозиторий
    ``git clone https://gitlab.sbmt.io/analytics/datazone/ab_methodology.git``
2. Установить [poetry](https://python-poetry.org/docs/). Дополнительно про установку и использование poetry можно почитать [здесь](https://wiki.sbmt.io/display/ANLT/Poetry).
3. Проверить установку poetry: ``poetry --version`` 
4. Выполнить ``poetry install --no-root`` 
5. Если вы используете библиотеку из ноутбука: 
    - ``poetry add ipykernel``
    - ``poetry run python -m ipykernel install --user --name ab_methodology``
    - выбрать установленный кернел 
6. Заполнить .env файл с кредами к БД
7. Использование коробочного решения для дизайна: 
    - ``poetry run python get_test.py '/full/path/to/test_params_name.py' '/full/path/to/connectors.env'``
    - например, ``poetry run python get_test.py "/home/previna/AB-1085_v4/test_params/test_params_ab_xxx.py" "/home/previna/AB-1085_v4/data/connectors.env"``
8. Использование библиотеки из коробки для получения оценки теста по магазинам: 
    - убедиться, что сплит лежит в одной директории с .py файлом
    - убедиться, что сплит называется по формату split_AB-xxxx.csv
    - ``poetry run python get_final_results.py '/full/path/to/test_params_name.py' '/full/path/to/connectors.env'``
9. Функционалом также можно пользоваться из ноутбука, пример в ``notebooks/test_example.ipynb``. 

## Тесты по магазинам
[Гайд](how_to_ab_stores.md) по использованию библиотеки для дизайна тестов по магазинам.

#### Пайплайн дизайна теста по магазинам 

<details markdown='1'><summary>Методология</summary> 

1. Заполнение конфига теста
2. Проверка корректности заполнения конфига эксперимента
    - корректно заполнены необходимые поля
    - заполнены минимально ожидаемые эффекты
    - нет нулевых минимально ожидаемых эффектов
    - название метрики совпадает с названием метрики `metrics_definition` из `data.handle_metrics`
    - корректно заполнено поле `stratification_params`
    - параметр стратификации `group_shares` -- список вида [group_share_1, group_share_2]
    - параметры стратификации `num_metrics`, `cat_metrics` должны быть списками. если нет количественных/категориальных метрик для стратификации, нужно передавать пустой список
    - сумма долей группы из`group_shares` равна единице
3. Загрузка генеральной совокупности из файла, указанного `test_params["gen_pop_csv_file_path"]`
4. Проверка корректности заполнения файла генеральной совокупности
    - колонка из `test_params["filter_column_id"]` должна присутствовать в файле генеральной совокупности
5. Автоматически определяются даты experimental (`test_params["w_length"]` недель назад от сегодняшней даты) и observational периода (`test_params["w_length"]` недель назад от начала experimental периода).
6. Загрузка исходных данных по установленным датам
7. Преобразование данных:
    - конвертация id магазина к store_uuid
    - форматирование даты в необходимый формат (DD-MM-YYYY или DD-MM-YYYY, HH)
    - фильтрация по генеральной совокупности
    - группировка данных к дате, city_id, retailer_id, юниту рандомизации
8. Получение сплитов по observational периоду:
    - Агрегация данных к юниту рандомизации, в случае ratio метрики агрегируется только числитель
    - Кластеризация метрик, разбиение метрик на бины
    - Выделение страты — уникального набора метрик
    - Внутри каждой страты юнит рандомизации случайно распределяются по группам, так каждая страта представлена в группах пропорционально генеральной совокупности
9. Фильтрация сплитов по медиане (дефолт) или максимуму подневной разницы для заданной метрики
10. Линеаризация в случае ratio метрики
11. Оценка AA через CUPED
    - Отрисовка и сохранение CDF графиков
    - Сохранение md таблицы с названиями метрики и FPR для 1% и 5% уровня значимости
12. Генерация синтетического эффекта
    - В случае ratio метрики генерируется эффект только на числитель, для корректного отображения на графиках дополнительно генерируется эффект
13. Оценка синтетических АБ через CUPED
14. Создание итогового сплита
    - start_date, end_date — даты начала и конца эксперимента
    - id юнита рандомизации из конфига теста
    - group — попадание в тестовую (group_0) или контрольную (group_1) группы
15. Отрисовка графиков по итоговому сплиту — расхождение групп по дням за experimental период
</details>

## Свитчбэк-тесты
[Гайд](how_to_switchback_ab.md) по использованию библиотеки для дизайна свитчбэк-тестов. 

#### Пайплайн свитчбэк-теста

<details markdown='1'><summary>Методология</summary>

1. Заполнение конфига теста  
2. Проверка корректности заполнения конфига эксперимента  
    - Корректно заполнены необходимые поля: `test_name`, `gen_pop_csv_file_path`, `filter_column_id`, `random_column_id`, `w_length`, `effects`, `aggregation`, `stratification_params`, `switchback_params`, `mlm_params`  
    - Заполнены минимальные ожидаемые эффекты  
    - Минимальные ожидаемые эффекты не нулевые  
    - Названия метрик должны соответствовать названиям числителя и знаменателя  
    - Для каждой метрики необходимо заполнить агрегацию (`order` — уровень заказов, `store_hour` -- магазин/час)  
    - Поле `switchback_params` должно быть заполнено для следующих параметров: `freq`, `switch_unit_name`  
    - `switch_unit_name` заполнен либо `city_id`, либо `operational_zone_id`  
    - Название географического юнита свитчбэка (`switch_unit_name`) не должно отличаться от названия группы для MLM/CRSE (`unit_interest`)  
    - Для поля `mlm_params` должно быть заполнено `unit_interest`  
    - Сумма долей групп в поле `group_shares` должна равняться 1  
3. Загрузка файла генеральной совокупности и проверка его заполнения  
4. Создание возможных свитчбэк-юнитов  
5. Загрузка и обработка данных  
6. Создание сплитов для симуляций  
7. АА тесты  
8. Генерация синтетического эффекта  
9. АБ тесты  
10. Опциональная оценка через MLM  
11. Создание финального сплита  
</details>

## Тесты по партнерам 

[Гайд](how_to_partner_tests.md) по использованию библиотеки для дизайна теста по партнерам.
